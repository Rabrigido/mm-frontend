<div class="p-3 space-y-3">

  <!-- Header / acciones -->
  <div class="flex flex-wrap items-center gap-2">
    <input
      type="text"
      class="border rounded px-2 py-1 min-w-[260px]"
      placeholder="Buscar función o archivo…"
      [ngModel]="search()"
      (ngModelChange)="search.set($event)"
    />

    <select
      class="border rounded px-2 py-1"
      [ngModel]="selectedDir()"
      (ngModelChange)="selectedDir.set($event)"
    >
      <option *ngFor="let d of dirs()" [value]="d">{{ d }}</option>
    </select>

    <label class="flex items-center gap-2">
      <span>Top N</span>
      <input
        type="number"
        min="0"
        class="border rounded px-2 py-1 w-24"
        [ngModel]="topN()"
        (ngModelChange)="topN.set($event ? +$event : 0)"
      />
    </label>

    <button class="border rounded px-3 py-1" (click)="exportCSV()">Exportar CSV</button>
    <button class="border rounded px-3 py-1" (click)="exportJSON()">Exportar JSON</button>

    <span class="ml-auto text-sm opacity-70"
      >Total coupling: {{ totalCoupling() | number:'1.0-0' }}</span
    >
  </div>

  <!-- Estados -->
  <div *ngIf="state().loading" class="p-3 rounded border">Cargando…</div>
  <div *ngIf="state().error" class="p-3 rounded border border-red-400 text-red-700">
    {{ state().error }}
  </div>

  <!-- Tabla -->
  <div class="overflow-auto">
    <table class="min-w-full border-collapse">
      <thead>
        <tr class="bg-gray-100">
          <th class="text-left p-2 border cursor-pointer" (click)="toggleSort('func')">
            función
            <span *ngIf="sortBy() === 'func'">({{ sortDir() }})</span>
          </th>
          <th class="text-left p-2 border cursor-pointer" (click)="toggleSort('file')">
            archivo
            <span *ngIf="sortBy() === 'file'">({{ sortDir() }})</span>
          </th>
          <th class="text-left p-2 border cursor-pointer" (click)="toggleSort('dir')">
            carpeta
            <span *ngIf="sortBy() === 'dir'">({{ sortDir() }})</span>
          </th>
          <th class="text-right p-2 border cursor-pointer" (click)="toggleSort('fanIn')">
            fan-in
            <span *ngIf="sortBy() === 'fanIn'">({{ sortDir() }})</span>
          </th>
          <th class="text-right p-2 border cursor-pointer" (click)="toggleSort('fanOut')">
            fan-out
            <span *ngIf="sortBy() === 'fanOut'">({{ sortDir() }})</span>
          </th>
          <th class="text-right p-2 border cursor-pointer" (click)="toggleSort('coupling')">
            coupling
            <span *ngIf="sortBy() === 'coupling'">({{ sortDir() }})</span>
          </th>
          <th class="text-right p-2 border cursor-pointer" (click)="toggleSort('instability')">
            I
            <span *ngIf="sortBy() === 'instability'">({{ sortDir() }})</span>
          </th>
          <th class="text-right p-2 border">
            % del total
          </th>
        </tr>
      </thead>
      <tbody>
        <tr
          *ngFor="let r of filteredSorted(); trackBy: trackRow"
          class="hover:bg-gray-50"
        >
          <td class="p-2 border font-mono">{{ r.func }}</td>
          <td class="p-2 border font-mono">{{ r.file }}</td>
          <td class="p-2 border">{{ r.dir || '(root)' }}</td>
          <td class="p-2 border text-right">{{ r.fanIn }}</td>
          <td class="p-2 border text-right">{{ r.fanOut }}</td>
          <td class="p-2 border text-right">{{ r.coupling }}</td>
          <td class="p-2 border text-right">
            {{ r.instability | number:'1.3-3' }}
          </td>
          <td class="p-2 border text-right">
            {{
              (totalCoupling() ? (r.coupling / totalCoupling()) * 100 : 0)
                | number:'1.2-2'
            }}%
          </td>
        </tr>
        <tr *ngIf="!state().loading && filteredSorted().length === 0">
          <td colspan="8" class="p-3 text-center text-sm opacity-70">
            Sin resultados con los filtros actuales.
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
