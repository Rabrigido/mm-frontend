<div class="fpfile">
  <div class="bar">
    <input
      type="search"
      placeholder="Buscar por ruta de archivo..."
      [value]="search()"
      (input)="search.set($any($event.target).value)"
    />

    <div class="right">
      <label>
        Tamaño página:
        <select
          [value]="pageSize()"
          (change)="pageSize.set(+$any($event.target).value)"
        >
          <option [value]="10">10</option>
          <option [value]="20">20</option>
          <option [value]="50">50</option>
          <option [value]="100">100</option>
        </select>
      </label>
    </div>
  </div>

  <div class="status" *ngIf="loading()">Cargando métrica…</div>
  <div class="status error" *ngIf="!loading() && error()">{{ error() }}</div>

  <div class="table-wrap" *ngIf="!loading() && !error()">
    <table class="table">
      <thead>
        <tr>
          <th (click)="onSort('path')" [class.active]="sortBy() === 'path'">
            Archivo
            <span class="sort" *ngIf="sortBy() === 'path'">{{
              sortDir() === "asc" ? "▲" : "▼"
            }}</span>
          </th>
          <th (click)="onSort('total')" [class.active]="sortBy() === 'total'">
            # Func
            <span class="sort" *ngIf="sortBy() === 'total'">{{
              sortDir() === "asc" ? "▲" : "▼"
            }}</span>
          </th>
          <th (click)="onSort('async')" [class.active]="sortBy() === 'async'">
            # Async
            <span class="sort" *ngIf="sortBy() === 'async'">{{
              sortDir() === "asc" ? "▲" : "▼"
            }}</span>
          </th>
          <th (click)="onSort('arrow')" [class.active]="sortBy() === 'arrow'">
            # Arrow
            <span class="sort" *ngIf="sortBy() === 'arrow'">{{
              sortDir() === "asc" ? "▲" : "▼"
            }}</span>
          </th>
          <th (click)="onSort('decl')" [class.active]="sortBy() === 'decl'">
            # Declaradas
            <span class="sort" *ngIf="sortBy() === 'decl'">{{
              sortDir() === "asc" ? "▲" : "▼"
            }}</span>
          </th>
          <th (click)="onSort('expr')" [class.active]="sortBy() === 'expr'">
            # Expresiones
            <span class="sort" *ngIf="sortBy() === 'expr'">{{
              sortDir() === "asc" ? "▲" : "▼"
            }}</span>
          </th>
          <th
            (click)="onSort('maxParams')"
            [class.active]="sortBy() === 'maxParams'"
          >
            Máx Params
            <span class="sort" *ngIf="sortBy() === 'maxParams'">{{
              sortDir() === "asc" ? "▲" : "▼"
            }}</span>
          </th>
          <th
            (click)="onSort('avgParams')"
            [class.active]="sortBy() === 'avgParams'"
          >
            Prom Params
            <span class="sort" *ngIf="sortBy() === 'avgParams'">{{
              sortDir() === "asc" ? "▲" : "▼"
            }}</span>
          </th>
        </tr>
      </thead>

      <tbody>
        <ng-container *ngFor="let r of paged(); trackBy: trackRow">
          <tr class="row" (click)="selectRow(r.path)">
            <td class="path">
              <span class="mono">{{ r.path }}</span>
            </td>
            <td>{{ r.total }}</td>
            <td>{{ r.async }}</td>
            <td>{{ r.arrow }}</td>
            <td>{{ r.decl }}</td>
            <td>{{ r.expr }}</td>
            <td>{{ r.maxParams }}</td>
            <td>{{ r.avgParams }}</td>
          </tr>

          <tr class="details" *ngIf="selectedPath() === r.path">
            <td colspan="8">
              <div class="detail-wrap">
                <div class="detail-head">
                  <strong>Funciones en {{ r.path }}</strong>
                  <span class="spacer"></span>
                  <button
                    class="btn"
                    (click)="selectedPath.set(null); $event.stopPropagation()"
                  >
                    Cerrar
                  </button>
                </div>

                <div
                  class="detail-list"
                  *ngIf="selectedFileFunctions().length; else nofuncs"
                >
                  <div
                    class="fn"
                    *ngFor="let f of selectedFileFunctions(); trackBy: trackFn"
                  >
                    <div class="left">
                      <div class="fn-name mono">{{ f.name }}</div>
                      <div class="fn-meta">
                        <span class="badge">{{ f.type || "desconocido" }}</span>
                        <span class="badge" *ngIf="f.async">async</span>
                        <span class="badge">params: {{ f.params }}</span>
                      </div>
                    </div>
                    <details class="node">
                      <summary>Ver nodo AST (JSON)</summary>
                      <pre>{{ f.node | json }}</pre>
                    </details>
                  </div>
                </div>

                <ng-template #nofuncs>
                  <div class="empty">
                    No se encontraron funciones en este archivo.
                  </div>
                </ng-template>
              </div>
            </td>
          </tr>
        </ng-container>
      </tbody>

      <tfoot>
        <tr>
          <td colspan="8">
            <div class="pager">
              <button class="btn" (click)="goPage(-1)">Anterior</button>
              <span>Página {{ page() }}</span>
              <button class="btn" (click)="goPage(1)">Siguiente</button>
              <span class="total">Total archivos: {{ sorted().length }}</span>
            </div>
          </td>
        </tr>
      </tfoot>
    </table>
  </div>

  <app-functions-bar-chart
    [title]="'Distribución de tipos de función'"
    [rawResult]="rawResult()"
  >
  </app-functions-bar-chart>

  <div class="mt-6">
    <!-- Treemap -->

    <!-- Sunburst con nombre de raíz custom-->
    <functions-per-folder-graph
      [data]="rawResult()"
      chartType="sunburst"
      rootName="src"
    />
    <div class="mt-2">
      <functions-per-folder-graph [data]="rawResult()" chartType="treemap" />
    </div>
  </div>
</div>
