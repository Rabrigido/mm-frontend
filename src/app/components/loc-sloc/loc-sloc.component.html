<div class="w-full space-y-4">
  <!-- Header / Controls -->
  <div class="flex flex-col md:flex-row gap-3 md:items-center">
    <div class="text-sm text-gray-700">
      Repo: <span class="font-mono">{{ repoId }}</span>
    </div>

    <div class="flex gap-2 md:ml-auto">
      <input
        type="text"
        placeholder="Filtrar por ruta de archivo…"
        class="px-3 py-2 rounded-lg border border-gray-300 text-sm w-64"
        [value]="q()"
        (input)="onFilterInput($any($event.target).value || '')"
      />
      <select
        class="px-3 py-2 rounded-lg border border-gray-300 text-sm"
        [value]="pageSize()"
        (change)="setPageSize( +$any($event.target).value )"
        title="Tamaño de página"
      >
        <option [value]="10">10</option>
        <option [value]="25">25</option>
        <option [value]="50">50</option>
        <option [value]="100">100</option>
      </select>
      <button
        class="px-3 py-2 rounded-lg text-sm bg-blue-600 text-white hover:bg-blue-700"
        (click)="fetch(true)"
      >
        Recargar
      </button>
      <button
        class="px-3 py-2 rounded-lg text-sm border border-gray-300 hover:bg-gray-50"
        (click)="downloadJSON()"
      >
        Descargar JSON
      </button>
    </div>
  </div>

  <!-- Loading / Error -->
  <div *ngIf="loading()" class="p-4 rounded-lg bg-gray-50 border border-gray-200">
    <span class="animate-pulse">Cargando LOC/SLOC…</span>
  </div>

  <div *ngIf="error()" class="p-4 rounded-lg bg-red-50 border border-red-200 text-red-700">
    {{ error() }}
  </div>

  <!-- Summary cards -->
  <div *ngIf="data() as d" class="grid grid-cols-1 sm:grid-cols-3 gap-3">
    <div class="p-4 rounded-xl border bg-white">
      <div class="text-xs text-gray-500">Archivos</div>
      <div class="text-2xl font-semibold">{{ d.fileCount }}</div>
    </div>
    <div class="p-4 rounded-xl border bg-white">
      <div class="text-xs text-gray-500">LOC Totales</div>
      <div class="text-2xl font-semibold">{{ d.total.loc | number }}</div>
    </div>
    <div class="p-4 rounded-xl border bg-white">
      <div class="text-xs text-gray-500">SLOC Totales</div>
      <div class="text-2xl font-semibold">{{ d.total.sloc | number }}</div>
    </div>
  </div>

  <!-- Gráficos -->
  <app-loc-sloc-graphs
    class="block"
    [data]="chartData()"
  ></app-loc-sloc-graphs>

  <!-- Tabla -->
  <div *ngIf="pagedRows().length" class="overflow-auto rounded-xl border">
    <table class="min-w-full text-sm">
      <thead class="bg-gray-50">
        <tr class="text-left">
          <th class="px-4 py-3 cursor-pointer" (click)="toggleSort('file')">
            Archivo
            <span class="text-gray-400" *ngIf="sortBy()==='file'">({{ sortDir() }})</span>
          </th>
          <th class="px-4 py-3 cursor-pointer" (click)="toggleSort('loc')">
            LOC
            <span class="text-gray-400" *ngIf="sortBy()==='loc'">({{ sortDir() }})</span>
          </th>
          <th class="px-4 py-3 cursor-pointer" (click)="toggleSort('sloc')">
            SLOC
            <span class="text-gray-400" *ngIf="sortBy()==='sloc'">({{ sortDir() }})</span>
          </th>
          <th class="px-4 py-3">Comentarios</th>
          <th class="px-4 py-3">% SLOC</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let r of pagedRows(); trackBy: trackByFile" class="border-t hover:bg-gray-50">
          <td class="px-4 py-2 font-mono text-[12px]">{{ r.file }}</td>
          <td class="px-4 py-2">{{ r.loc | number }}</td>
          <td class="px-4 py-2">{{ r.sloc | number }}</td>
          <td class="px-4 py-2">{{ r.comments | number }}</td>
          <td class="px-4 py-2">{{ fmtPct(r.slocRatio) }}</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div *ngIf="!loading() && !error() && data() && rows().length === 0" class="text-gray-500">
    No hay archivos que coincidan con el filtro.
  </div>

  <!-- Controles de paginación -->
  <div *ngIf="totalRows() > 0" class="flex items-center justify-between text-sm">
    <div class="text-gray-600">
      {{
        (pageIndex() * pageSize()) + 1
      }}–{{
        ( ((pageIndex() + 1) * pageSize()) < totalRows() ? ((pageIndex() + 1) * pageSize()) : totalRows() ) | number
      }} de {{ totalRows() | number }}
    </div>
    <div class="flex items-center gap-2">
      <button
        class="px-3 py-1.5 rounded-lg border disabled:opacity-50"
        [disabled]="pageIndex() === 0"
        (click)="prevPage()"
      >
        ‹ Anterior
      </button>
      <span>Pág. {{ pageIndex() + 1 }} / {{ pageCount() }}</span>
      <button
        class="px-3 py-1.5 rounded-lg border disabled:opacity-50"
        [disabled]="pageIndex() >= pageCount() - 1"
        (click)="nextPage()"
      >
        Siguiente ›
      </button>
    </div>
  </div>
</div>
